---
template: overrides/main.html
search:
  exclude: true
---

# Search: better, faster, smaller

__This is the story of how we managed to completely rebuild client-side search, delivering a significantly better user experience, while making it faster and smaller at the same time.__

<aside class="mdx-author" markdown="1">
![@squidfunk][1]

<span>__Martin Donath__ · @squidfunk</span>
<span>
:octicons-calendar-24: September 12, 2021 ·
:octicons-clock-24: 15 min read
</span>
</aside>

  [1]: https://avatars.githubusercontent.com/u/932156

---

The [search][2] of Material for MkDocs is genuinely one of its best and most-loved assets: fast, [multi-lingual][3], [offline-capable][4] and most importantly: _all client-side_. It provides a solution to empower the users of your documentation to find what they're searching for instantly without the headache of managing additional servers. However, even though several iterations have been made, there's still some room for improvement, which is why we rebuilt the search plugin and integration from the ground up. This article shines some light on the internals of the new search, why it's much more powerful than the previous version and what's about to come.

_The next section explains the architecture and issues of the current search implementation. If you immediately want to learn what's new, skip to the [next section][5]._

  [2]: ../../setup/setting-up-site-search.md
  [3]: ../../setup/setting-up-site-search.md#lang
  [4]: ../../setup/setting-up-site-search.md#offline-search
  [5]: #whats-new

## Architecture

Material for MkDocs uses [lunr][6] together with [lunr-languages][7] to implement its client-side search capabilities. When a documentation page is loaded and JavaScript is available, the search index as generated by the [built-in search plugin][8] during the build process is requested from the server:

``` ts
const index$ = document.forms.namedItem("search")
  ? __search?.index || requestJSON<SearchIndex>(
    new URL("search/search_index.json", config.base)
  )
  : NEVER
```

  [6]: https://lunrjs.com
  [7]: https://github.com/MihaiValentin/lunr-languages
  [8]: ../../setup/setting-up-site-search.md#built-in-search

### Search index

The search index includes a stripped-down version of all pages. Let's take a look at an example, to understand precisely what the search index contains from the original Markdown file:

??? example "Expand to inspect example"

    === "`docs/page.md`"

        ```` markdown
        # Example

        ## Text

        It's very easy to make some words **bold** and other words *italic* with
        Markdown. You can even add [links](#), or even `code`:

        ```
        if (isAwesome) {
          return true
        }
        ```

        ## Lists

        Sometimes you want numbered lists:

        1. One
        2. Two
        3. Three

        Sometimes you want bullet points:

        * Start a line with a star
        * Profit!
        ````

    === "`search_index.json`"

        ``` json
        {
          "config": {
            "indexing": "full",
            "lang": [
              "en"
            ],
            "min_search_length": 3,
            "prebuild_index": false,
            "separator": "[\\s\\-]+"
          },
          "docs": [
            {
              "location": "page/",
              "title": "Example",
              "text": "Example Text It's very easy to make some words bold and other words italic with Markdown. You can even add links , or even code : if (isAwesome) { return true } Lists Sometimes you want numbered lists: One Two Three Sometimes you want bullet points: Start a line with a star Profit!"
            },
            {
              "location": "page/#example",
              "title": "Example",
              "text": ""
            },
            {
              "location": "page/#text",
              "title": "Text",
              "text": "It's very easy to make some words bold and other words italic with Markdown. You can even add links , or even code : if (isAwesome) { return true }"
            },
            {
              "location": "page/#lists",
              "title": "Lists",
              "text": "Sometimes you want numbered lists: One Two Three Sometimes you want bullet points: Start a line with a star Profit!"
            }
          ]
        }
        ```

If we inspect the search index, we immediately see several problems:

  1. __All content is included twice__: the search index includes one entry with the entire contents of the page, and one entry for each section of the page, i.e. each block preceded by a headline or subheadline. This significantly increases the size of the search index.

  2. __All structure is lost__: when the search index is built, all structural information like HTML tags and attributes are stripped from the content. While this approach works well for paragraphs and inline formatting, it might be problematic for lists and code blocks. An excerpt:

    ```
    … links , or even code : if (isAwesome) { … } Lists Sometimes you want …
    ```

    - __Context__: for an untrained eye, the result can look like gibberish, as it's not immediately apparent what classifies as text and what as code. Furthermore, it's not clear that `Lists` is a headline as it's merged with the code block before and the paragraph after it.

    - __Punctuation__: inline elements like links, that are immediately followed by punctuation are separated by whitespace (see `,` and `:` in the excerpt). This is because all extracted text is joined with a whitespace character during the construction of the search index.

It's not difficult to see that it can be quite challenging to implement a good search experience for theme authors, which is why Material for MkDocs (up to now) does some [monkey patching][9] to be able to render more meaningful search previews.

### Search worker

The actual search functionality is implemented as part of a web worker[^1], which creates and manages the [lunr][6] search index. When search is initialized, the following steps are taken:

  [^1]: Prior to [version 5.0][10], search was carried out in the main thread which locked up the browser, rendering it unusable. This problem was first reported in #904 and, after some back and forth, fixed and released in version 5.0.

1. __Linking sections with pages__: The search index is parsed and each section is linked to its parent page. The parent page itself is _not indexed_, as it would lead to duplicate results, so only the sections remain. Linking is necessary, as search results need to be grouped by page.

2. __Tokenization__: The `title` and `text` values of each section are split into tokens by using the [separator][11] as configured in `mkdocs.yml`. Tokenization itself is carried out by [lunr's default tokenizer][12], which doesn't allow for lookahead or separators spanning multiple characters.

    > Why is this important and a big deal? We will see later how much more we can achieve with a tokenizer that is capable of separating strings with lookahead.

3. __Indexing__: As a final step, each section is indexed. When querying the index, if a search query includes one of the tokens as returned by step 2., the section is considered to be part of the search result and passed to the main thread.

Now, that's basically how the search worker operates. Sure, there's a little more magic involved, e.g. search results are [post-processed][13] and [rescored][14] to account for some shortcomings of [lunr][6], but in general this is how search results get into and out of the index.

  [9]: https://github.com/squidfunk/mkdocs-material/blob/ec7ccd2b2d15dd033740f388912f7be7738feec2/src/assets/javascripts/integrations/search/document/index.ts#L68-L71
  [10]: https://squidfunk.github.io/mkdocs-material/upgrading/#upgrading-from-4x-to-5x
  [11]: ../../setup/setting-up-site-search.md#separator
  [12]: https://github.com/olivernn/lunr.js/blob/aa5a878f62a6bba1e8e5b95714899e17e8150b38/lunr.js#L413-L456
  [13]: https://github.com/squidfunk/mkdocs-material/blob/ec7ccd2b2d15dd033740f388912f7be7738feec2/src/assets/javascripts/integrations/search/_/index.ts#L249-L272
  [14]: https://github.com/squidfunk/mkdocs-material/blob/ec7ccd2b2d15dd033740f388912f7be7738feec2/src/assets/javascripts/integrations/search/_/index.ts#L274-L275

### Search previews

Users should be able to quickly scan an evaluate the relevance of a search result in the given context, which is why a concise summary with highlighted occurrences of the words found is an essential part of a great search experience.

This is where the current search preview generation falls short, as some of the search previews appear to not include any occurrence of any of the search terms. This was due to the fact that search previews were [truncated after 320 characters][15], as can be seen here:

<figure markdown="1">

![Search previews][16]

  <figcaption markdown="1">

The first two results look like they're not relevant, as they don't seem to include the query string the user just searched for. Yet, they are.

  </figcaption>
</figure>

A better solution to this problem has been on the roadmap for a very, very long time, but in order to solve this once and for all, several factors need to be carefully considered:

1. __Word boundaries__: some themes[^2] for static site generators generate search previews by expanding the text left and right next to an occurrence, stopping at a whitespace character when enough words have been consumed. A preview might look like this:

    ``` 
    … channels, e.g. or which can be configured via mkdocs.yml.
    ```

    While this may work for languages that use whitespace as a separator between words, it breaks down for languages like Japanese or Chinese[^3], as they have non-whitespace word boundaries and use dedicated segmenters to split strings into tokens.

  [^2]: At the time of writing, [Just the Docs][17] and [Docusaurus][18] use this method for generating search previews. Note that the latter by default uses Algolia, which is a fully managed server-based solution.

  [^3]: In fact, China and Japan are both within the top 5 countries of origin of users of Material for MkDocs.

  [15]: https://github.com/squidfunk/mkdocs-material/blob/master/src/assets/javascripts/templates/search/index.tsx#L90
  [16]: search-better-faster-smaller/search-preview.png
  [17]: https://pmarsceill.github.io/just-the-docs/
  [18]: https://github.com/lelouch77/docusaurus-lunr-search

2. __Context awareness__: Although whitespace doesn't work for all languages, one could argue that it could be a good-enough solution. Unfortunately, this is not necessarily true for code blocks, as the removal of whitespace might change meaning in some languages.

3. __Structure__: Preserving structural information is not a must, but apparently beneficial to build more meaningful search previews which allow for a quick evaluation of relevance. If the user expects a match within a code block, it should be rendered as a code block.

## What's new?

After we built a solid understanding of the problem space and before we dive into the internals of the new search implementation to see which of the problems it already solves, a quick overview:

- __Better__: support for [rich search previews][19], preserving the structural information of code blocks, inline code and lists, so they are rendered as-is, as well as [lookahead tokenization][20], [more accurate highlighting][21], and improved stability of typeahead. Also, a [slightly better UX][22].
- __Faster__ and __smaller__: significant decrease in search index size of up to 50%, due to improved extraction and construction techniques, resulting in up to 40% faster search, yielding huge improvements, particularly for large documentation projects.

  [19]: #rich-search-previews
  [20]: #tokenizer-lookahead
  [21]: #
  [22]: #

### Rich search previews

As we've rebuilt the search plugin from scratch, we reworked the construction of the search index to preserve the structural information of code blocks, inline code, as well as unordered and ordered lists. Using the example from the [search index][23] section, here's how it looks:

=== "Now"

    ![Search preview now][24]

=== "Before"

    ![Search preview before][25]

Now, code blocks are first-class citizens of search previews, and even inline code formatting is preserved. Let's take a look at the new structure of the search index to understand why:

??? example "Expand to inspect search index"

    === "Now"

        ``` json
        {
          ...
          "docs": [
            {
              "location": "page/",
              "title": "Example",
              "text": ""
            },
            {
              "location": "page/#text",
              "title": "Text",
              "text": "<p>It's very easy to make some words bold and other words italic with Markdown. You can even add links, or even <code>code</code>:</p> <pre><code>if (isAwesome){\n  return true\n}\n</code></pre>"
            },
            {
              "location": "page/#lists",
              "title": "Lists",
              "text": "<p>Sometimes you want numbered lists:</p> <ol> <li>One</li> <li>Two</li> <li>Three</li> </ol> <p>Sometimes you want bullet points:</p> <ul> <li>Start a line with a star</li> <li>Profit!</li> </ul>"
            }
          ]
        }
        ```

    === "Before"

        ``` json
        {
          ...
          "docs": [
            {
              "location": "page/",
              "title": "Example",
              "text": "Example Text It's very easy to make some words bold and other words italic with Markdown. You can even add links , or even code : if (isAwesome) { return true } Lists Sometimes you want numbered lists: One Two Three Sometimes you want bullet points: Start a line with a star Profit!"
            },
            {
              "location": "page/#example",
              "title": "Example",
              "text": ""
            },
            {
              "location": "page/#text",
              "title": "Text",
              "text": "It's very easy to make some words bold and other words italic with Markdown. You can even add links , or even code : if (isAwesome) { return true }"
            },
            {
              "location": "page/#lists",
              "title": "Lists",
              "text": "Sometimes you want numbered lists: One Two Three Sometimes you want bullet points: Start a line with a star Profit!"
            }
          ]
        }
        ```

If we inspect the search index again, we can see how the situation improved:

1. __All content is included once__: the search index does not include the content of the page twice, as only the sections of a page are part of the search index. This leads to a significant reduction in size, fewer bytes to transfer and a smaller search index.

2. __Some structure is preserved__: each section of the search index includes a small subset of HTML to provide the necessary structure to allow for more sophisticated search previews. Revisiting our example from before, let's look at an excerpt:

    === "Now"

        ``` html
        … links, or even <code>code</code>:</p> <pre><code>if (isAwesome){ … }\n</code></pre>
        ```

    === "Before"

        ```
        … links , or even code : if (isAwesome) { … }
        ```

    The punctuation issue is gone, as no additional whitespace is inserted, and the preserved markup yields additional context to make scanning search results more effective.

On to the next step in the process: __tokenization__.

  [23]: #search-index
  [24]: search-better-faster-smaller/search-preview-now.png
  [25]: search-better-faster-smaller/search-preview-before.png

### Tokenizer lookahead

- explain tokenization
- add examples explaining lookahead
    - camelcase
    - version numbers
    - code examples (<> etc...)

## Highlighting

- the problem with highlighting
- how highlighting was implemented
- how its implemented now
- division into blocks
- ux improvements
  - scrolling more button
  - search exclude
